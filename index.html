<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Portal Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        html, body {
          min-height: 100vh;
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          background: #0a0e1a;
          overflow-x: hidden;
        }

        .bg-3d {
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          z-index: 0;
          overflow: hidden;
          background: radial-gradient(ellipse at top, #1a2855 0%, #0a0e1a 50%, #000000 100%);
        }

        .gradient-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          z-index: 1;
          opacity: 0.4;
          background: linear-gradient(45deg,
            rgba(59, 130, 246, 0.1) 0%,
            rgba(139, 92, 246, 0.1) 25%,
            rgba(236, 72, 153, 0.1) 50%,
            rgba(59, 130, 246, 0.1) 75%,
            rgba(139, 92, 246, 0.1) 100%
          );
          background-size: 400% 400%;
          animation: gradientFlow 15s ease infinite;
          pointer-events: none;
        }

        @keyframes gradientFlow {
          0%, 100% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
        }

        #three-bg {
          width: 100vw;
          height: 100vh;
          display: block;
          position: absolute;
          top: 0;
          left: 0;
          z-index: 2;
          pointer-events: none;
        }

        .login-wrapper {
          min-height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
          z-index: 3;
          padding: 20px;
        }

        .login-container {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(20px) saturate(180%);
          -webkit-backdrop-filter: blur(20px) saturate(180%);
          border-radius: 24px;
          box-shadow:
            0 8px 32px rgba(0, 0, 0, 0.1),
            0 1px 2px rgba(0, 0, 0, 0.05),
            inset 0 1px 1px rgba(255, 255, 255, 0.9);
          max-width: 440px;
          width: 100%;
          padding: 48px 40px;
          animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1);
          border: 1px solid rgba(255, 255, 255, 0.18);
        }

        @keyframes fadeInUp {
          from { opacity: 0; transform: translateY(30px) scale(0.95); }
          to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .login-title {
          color: #1e293b;
          font-size: 2rem;
          font-weight: 700;
          text-align: center;
          margin-bottom: 8px;
          line-height: 1.2;
          letter-spacing: -0.5px;
        }

        .login-desc {
          font-size: 0.95rem;
          color: #64748b;
          text-align: center;
          margin-bottom: 36px;
        }

        .login-form {
          display: flex;
          flex-direction: column;
          gap: 24px;
        }

        .form-group {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        label {
          font-size: 0.875rem;
          color: #334155;
          font-weight: 600;
          margin-left: 4px;
        }

        input[type="email"],
        input[type="password"] {
          width: 100%;
          padding: 14px 16px;
          border: 2px solid #e2e8f0;
          border-radius: 12px;
          font-size: 0.95rem;
          background: #ffffff;
          color: #1e293b;
          outline: none;
          transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        input:focus {
          border-color: #3b82f6;
          box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .login-btn {
          width: 100%;
          padding: 14px;
          background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
          border: none;
          border-radius: 12px;
          color: #ffffff;
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
          transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .login-btn:hover {
          background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
          transform: translateY(-2px);
          box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        .login-btn:active {
          transform: translateY(0);
        }

        .login-btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
          transform: none;
        }

        .error-message {
          background: #fee2e2;
          border: 1px solid #fecaca;
          color: #991b1b;
          padding: 12px 16px;
          border-radius: 8px;
          font-size: 0.875rem;
          margin-top: 16px;
          animation: shake 0.5s ease;
        }

        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-10px); }
          75% { transform: translateX(10px); }
        }
    </style>
</head>

<body>
<div class="bg-3d"></div>
<div class="gradient-overlay"></div>
<canvas id="three-bg"></canvas>

<div class="login-wrapper">
    <div class="login-container">
        <h2 class="login-title">University Portal</h2>
        <p class="login-desc">Access your academic records, course schedules, and fee status securely.</p>

        <form class="login-form" id="login-form" autocomplete="off">
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" placeholder="student@university.edu" required>
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" placeholder="Enter your password" required>
            </div>

            <button class="login-btn" type="submit">Sign In</button>
        </form>

        <div id="error-container"></div>
    </div>
</div>

<!-- THREE.JS Background -->
<script src="https://cdn.jsdelivr.net/npm/three@0.151.3/build/three.min.js"></script>
<script>
    // THREE.JS BACKGROUND ANIMATION
    const canvas = document.getElementById('three-bg');
    const scene = new THREE.Scene();
    let width = window.innerWidth;
    let height = window.innerHeight;

    const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
    camera.position.z = 50;

    const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
    renderer.setSize(width, height);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setClearColor(0x000000, 0);

    const ambLight = new THREE.AmbientLight(0xffffff, 0.3);
    scene.add(ambLight);

    const pointLight1 = new THREE.PointLight(0x3b82f6, 1, 100);
    pointLight1.position.set(20, 20, 20);
    scene.add(pointLight1);

    const pointLight2 = new THREE.PointLight(0x8b5cf6, 0.8, 100);
    pointLight2.position.set(-20, -20, 20);
    scene.add(pointLight2);

    const shapes = [];
    const geometries = [
      new THREE.IcosahedronGeometry(1.5, 0),
      new THREE.OctahedronGeometry(1.8, 0),
      new THREE.TetrahedronGeometry(2, 0)
    ];
    const colors = [0x3b82f6, 0x8b5cf6, 0x06b6d4, 0xec4899];

    for (let i = 0; i < 12; i++) {
      const geometry = geometries[Math.floor(Math.random() * geometries.length)];
      const material = new THREE.MeshPhongMaterial({
        color: colors[Math.floor(Math.random() * colors.length)],
        transparent: true,
        opacity: 0.15 + Math.random() * 0.15,
        shininess: 80,
        wireframe: Math.random() > 0.5
      });

      const mesh = new THREE.Mesh(geometry, material);
      mesh.position.x = (Math.random() - 0.5) * 100;
      mesh.position.y = (Math.random() - 0.5) * 80;
      mesh.position.z = (Math.random() - 0.5) * 60;
      scene.add(mesh);

      shapes.push({
        mesh,
        rotationSpeed: { x: (Math.random() - 0.5) * 0.01, y: (Math.random() - 0.5) * 0.01 },
        floatSpeed: 0.3 + Math.random() * 0.5,
        floatOffset: Math.random() * Math.PI * 2,
        baseY: mesh.position.y
      });
    }

    let time = 0;
    function animate() {
      requestAnimationFrame(animate);
      time += 0.01;
      shapes.forEach((s, i) => {
        s.mesh.rotation.x += s.rotationSpeed.x;
        s.mesh.rotation.y += s.rotationSpeed.y;
        s.mesh.position.y = s.baseY + Math.sin(time * s.floatSpeed + s.floatOffset) * 3;
      });
      camera.lookAt(scene.position);
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
      width = window.innerWidth;
      height = window.innerHeight;
      camera.aspect = width / height;
      camera.updateProjectionMatrix();
      renderer.setSize(width, height);
    });

    // ============================================
    // BACKEND INTEGRATION - FIXED VERSION
    // ============================================
    const API_BASE_URL = 'http://localhost:8080/api/v1';
    const loginForm = document.getElementById('login-form');
    const errorContainer = document.getElementById('error-container');

    function showError(message) {
        errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
        setTimeout(() => {
            errorContainer.innerHTML = '';
        }, 5000);
    }

    if (loginForm) {
      loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        const loginBtn = document.querySelector('.login-btn');

        if (!email || !password) {
            showError('Please enter both email and password.');
            return;
        }

        loginBtn.disabled = true;
        loginBtn.textContent = 'Signing In...';
        errorContainer.innerHTML = '';

        try {
          const response = await fetch(`${API_BASE_URL}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: email, password }),
            credentials: 'include'
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || 'Invalid credentials or server error.');
          }

          const data = await response.json();

          // FIXED: Store complete user object with all necessary data
          const userData = {
            id: data.id,
            firstName: data.firstName || data.first_name || '',
            lastName: data.lastName || data.last_name || '',
            email: data.email,
            role: data.role,
            children: data.children || []
          };

          localStorage.setItem('currentUser', JSON.stringify(userData));

          // Store auth token if provided
          if (data.token) {
            localStorage.setItem('authToken', data.token);
          }

          // Determine redirect URL based on role
          let redirectUrl = 'profile.html';
          if (data.role === 'admin') {
            redirectUrl = 'dashboard.html';
          } else if (data.role === 'parent') {
            redirectUrl = 'parent.html';
          }

          console.log('Login successful:', userData);
          console.log('Redirecting to:', redirectUrl);

          loginBtn.textContent = 'Success! Redirecting...';
          loginBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';

          setTimeout(() => {
            window.location.href = redirectUrl;
          }, 800);

        } catch (err) {
          console.error('Login error:', err);
          showError(`Login Failed: ${err.message}`);
          loginBtn.disabled = false;
          loginBtn.textContent = 'Sign In';
        }
      });
    }

    console.log('Login page loaded. Backend URL:', API_BASE_URL);
    console.log('Ready to authenticate users...');
</script>
</body>
</html>