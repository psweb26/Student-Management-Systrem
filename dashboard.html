<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --primary-light: #818cf8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3), transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(138, 80, 182, 0.3), transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .content-wrapper {
            position: relative;
            z-index: 1;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow:
                0 8px 32px 0 rgba(31, 38, 135, 0.15),
                0 2px 8px 0 rgba(31, 38, 135, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            box-shadow:
                0 12px 40px 0 rgba(31, 38, 135, 0.2),
                0 4px 12px 0 rgba(31, 38, 135, 0.15);
            transform: translateY(-2px);
        }

        .header-glass {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .tab-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .tab-btn::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .tab-btn.active::before {
            transform: scaleY(1);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
        }

        .tab-btn:not(.active):hover {
            background: rgba(79, 70, 229, 0.05);
            transform: translateX(4px);
        }

        .custom-modal {
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            animation: modalSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .table-row {
            transition: all 0.2s ease;
        }

        .table-row:hover {
            background: linear-gradient(90deg, rgba(79, 70, 229, 0.05) 0%, transparent 100%);
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }

        .input-field {
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow:
                0 0 0 3px rgba(79, 70, 229, 0.1),
                0 1px 3px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 14px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .badge:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }

        .badge-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .badge-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .badge-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .course-card {
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
        }

        .course-card:hover {
            border-color: var(--primary-light);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.15);
            transform: translateX(4px);
        }

        .section-title {
            position: relative;
            display: inline-block;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary) 0%, transparent 100%);
            border-radius: 2px;
        }

        .avatar-circle {
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.8), 0 0 0 4px var(--primary-light);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div class="content-wrapper">
    <div id="custom-modal" class="custom-modal fixed inset-0 hidden items-center justify-center">
        <div class="modal-content glass-card p-8 rounded-2xl w-96 text-center">
            <div class="mb-4">
                <div id="modal-icon" class="w-16 h-16 mx-auto rounded-full flex items-center justify-center">
                </div>
            </div>
            <h3 id="modal-title" class="text-2xl font-bold mb-2 text-gray-800"></h3>
            <p id="modal-message" class="text-gray-600 mb-6 leading-relaxed"></p>
            <button id="modal-close-btn" class="px-6 py-3 rounded-xl font-semibold text-white btn-primary w-full">
                Close
            </button>
        </div>
    </div>

    <header class="header-glass sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Admin Portal</h1>
                        <p class="text-sm text-gray-600">Dashboard & Management</p>
                    </div>
                </div>
                <button onclick="handleLogout()" class="flex items-center space-x-2 px-4 py-2 rounded-xl text-gray-700 hover:bg-gray-100 transition duration-200" style="box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    <span class="font-medium">Logout</span>
                </button>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto mt-8 px-6 lg:px-8 pb-12">
        <div class="flex flex-col lg:flex-row gap-6">

            <aside class="lg:w-72 flex-shrink-0">
                <nav class="glass-card p-4 rounded-2xl sticky lg:top-24">
                    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 px-3">Navigation</h2>
                    <div class="space-y-1">
                        <button class="tab-btn active w-full text-left px-4 py-3 rounded-xl font-medium flex items-center space-x-3" onclick="showTab('student_management')">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                            <span>Student Records</span>
                        </button>

                        <button class="tab-btn w-full text-left px-4 py-3 rounded-xl text-gray-700 font-medium flex items-center space-x-3" onclick="showTab('academic_management')">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span>Academic Grades</span>
                        </button>

                        <button class="tab-btn w-full text-left px-4 py-3 rounded-xl text-gray-700 font-medium flex items-center space-x-3" onclick="showTab('fee_management')">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>Fee Tracking</span>
                        </button>

                        <button class="tab-btn w-full text-left px-4 py-3 rounded-xl text-gray-700 font-medium flex items-center space-x-3" onclick="showTab('course_management')">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                            <span>Course Management</span>
                        </button>
                    </div>
                </nav>
            </aside>

            <main class="flex-1 min-w-0">

                <div id="student_management" class="tab-content fade-in">
                    <div class="glass-card p-8 rounded-2xl">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800 section-title">Student Records</h2>
                                <p class="text-sm text-gray-600 mt-3">Manage and view all student information</p>
                            </div>
                        </div>

                        <div class="mb-6 flex flex-col sm:flex-row gap-3">
                            <div class="flex-1 relative">
                                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                <input type="text" id="search-input" placeholder="Search by ID or Name" class="input-field w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl">
                            </div>
                            <button onclick="fetchStudentRecords(document.getElementById('search-input').value)" class="btn-primary px-6 py-3 text-white rounded-xl font-semibold">
                                Search
                            </button>
                            <button onclick="createStudent({id: 'NEW'+Math.floor(Math.random()*100000), firstName: 'New', lastName: 'Student', major: 'IT', grade: 10, email: 'new'+Math.floor(Math.random()*1000)+'@example.com', password: 'password123'})" class="px-6 py-3 text-white rounded-xl font-semibold" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);">
                                Add Student
                            </button>
                        </div>

                        <div class="overflow-x-auto rounded-xl border border-gray-200" style="box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Student ID</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Major</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                                </tr>
                                </thead>
                                <tbody id="student-records-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="4" class="text-center py-8 text-gray-500">
                                        <div class="flex flex-col items-center">
                                            <div class="rounded-full h-8 w-8 border-b-2 border-indigo-600 mb-3" style="animation: spin 1s linear infinite;"></div>
                                            <p>Fetching records...</p>
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="academic_management" class="tab-content hidden fade-in">
                    <div class="glass-card p-8 rounded-2xl">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 section-title">Academic Records</h2>
                            <p class="text-sm text-gray-600 mt-3">Update student grades and academic progress</p>
                        </div>

                        <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-6 rounded-xl border border-indigo-100" style="box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1);">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Student ID</label>
                                    <input type="text" id="grade-student-id" placeholder="e.g., S101" class="input-field w-full px-4 py-3 border-2 border-gray-200 rounded-xl">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Course Code</label>
                                    <input type="text" id="grade-course-code" placeholder="e.g., 21CSC203P" class="input-field w-full px-4 py-3 border-2 border-gray-200 rounded-xl">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">New Grade</label>
                                    <select id="grade-select" class="input-field w-full px-4 py-3 border-2 border-gray-200 rounded-xl">
                                        <option value="" disabled selected>Select Grade</option>
                                        <option value="A+">A+</option>
                                        <option value="A">A</option>
                                        <option value="B+">B+</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                    </select>
                                </div>
                                <button onclick="handleGradeUpdate()" class="btn-primary w-full py-3 text-white rounded-xl font-semibold">
                                    Update Grade
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="fee_management" class="tab-content hidden fade-in">
                    <div class="glass-card p-8 rounded-2xl">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 section-title">Fee Tracking</h2>
                            <p class="text-sm text-gray-600 mt-3">Monitor outstanding dues and record payments</p>
                        </div>

                        <div class="mb-6 flex gap-3">
                            <input type="text" id="fee-student-id" placeholder="Enter Student ID" class="input-field flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl">
                            <button onclick="fetchFeeRecords(document.getElementById('fee-student-id').value)" class="px-6 py-3 text-white rounded-xl font-semibold" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);">
                                Check Fees
                            </button>
                        </div>

                        <div class="bg-gradient-to-br from-yellow-50 to-orange-50 p-6 rounded-xl border border-amber-200" style="box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-800">Fee Status</h3>
                                <span id="current-fee-status-badge" class="badge badge-warning">N/A</span>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div class="bg-white p-4 rounded-xl" style="box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                                    <p class="text-sm text-gray-600 mb-1">Student ID</p>
                                    <p id="current-fee-id" class="text-xl font-bold text-gray-800">N/A</p>
                                </div>
                                <div class="bg-white p-4 rounded-xl" style="box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                                    <p class="text-sm text-gray-600 mb-1">Pending Balance</p>
                                    <p id="current-fee-balance" class="text-xl font-bold text-red-600">â‚¹0.00</p>
                                </div>
                            </div>

                            <div class="bg-white p-4 rounded-xl mb-4" style="box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                                <p class="text-sm text-gray-600 mb-1">Last Payment Date</p>
                                <p id="last-payment-date" class="text-base font-semibold text-gray-800">N/A</p>
                            </div>

                            <button onclick="recordPayment(document.getElementById('fee-student-id').value)" class="w-full py-3 text-white rounded-xl font-semibold" style="background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); box-shadow: 0 4px 15px rgba(20, 184, 166, 0.3);">
                                Record Payment
                            </button>
                        </div>
                    </div>
                </div>

                <div id="course_management" class="tab-content hidden fade-in">
                    <div class="glass-card p-8 rounded-2xl">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 section-title">Course Management</h2>
                            <p class="text-sm text-gray-600 mt-3">Add or remove courses from the system</p>
                        </div>

                        <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-6 rounded-xl border border-indigo-100 mb-8" style="box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1);">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Add New Course</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Course Code</label>
                                    <input type="text" id="new-course-code" placeholder="e.g., 21CSC203P" class="input-field w-full px-4 py-3 border-2 border-gray-200 rounded-xl">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Course Name</label>
                                    <input type="text" id="new-course-name" placeholder="e.g., Data Structures" class="input-field w-full px-4 py-3 border-2 border-gray-200 rounded-xl">
                                </div>
                                <button onclick="createCourse(document.getElementById('new-course-code').value, document.getElementById('new-course-name').value)" class="btn-primary w-full py-3 text-white rounded-xl font-semibold">
                                    Add Course
                                </button>
                            </div>
                        </div>

                        <h3 class="text-lg font-bold text-gray-800 mb-4">Existing Courses</h3>
                        <div id="course-list" class="space-y-3">
                            <div class="text-center py-8 text-gray-500">
                                <p>Loading courses...</p>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>
</div>
<script>
    // --- Configuration and Core UI Helpers (Retained) ---
    const API_BASE_URL = 'http://localhost:8080/api/v1';
    const modal = document.getElementById('custom-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalIcon = document.getElementById('modal-icon');
    const modalCloseBtn = document.getElementById('modal-close-btn');

    function showMessage(title, message, type = 'info') {
        if (!modal) return;

        modalTitle.textContent = title;
        modalMessage.textContent = message;

        let iconHTML = '';
        let iconBg = '';

        if (type === 'error') {
            iconBg = 'bg-red-100';
            iconHTML = '<svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
        } else if (type === 'success') {
            iconBg = 'bg-green-100';
            iconHTML = '<svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
        } else {
            iconBg = 'bg-blue-100';
            iconHTML = '<svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        }

        modalIcon.className = `w-16 h-16 mx-auto rounded-full flex items-center justify-center ${iconBg}`;
        modalIcon.innerHTML = iconHTML;

        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    if (modalCloseBtn) {
        modalCloseBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });
    }

    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        });
    }

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.add('hidden');
        });

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        const activeTab = document.getElementById(tabId);
        if (activeTab) {
            activeTab.classList.remove('hidden');
        }

        const activeBtn = document.querySelector(`.tab-btn[onclick*="${tabId}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
    }

    // --- START: Integrated and Fixed Functions ---

    // Auth Helpers
    function getAuthToken() {
        return localStorage.getItem('authToken') || localStorage.getItem('token') || '';
    }

    function authHeaders(extra = {}) {
        const token = getAuthToken();
        const h = Object.assign({ 'Content-Type': 'application/json' }, extra);
        if (token) h['Authorization'] = `Bearer ${token}`;
        return h;
    }

    async function fetchWithAuth(url, opts = {}, includeAuth = true) {
        const finalOpts = Object.assign({}, opts);
        finalOpts.headers = Object.assign({}, (opts.headers || {}), includeAuth ? authHeaders() : { 'Content-Type': 'application/json' });
        const resp = await fetch(url, finalOpts);
        return resp;
    }

    // Student ID Helper (for robust property access)
    function getStudentId(student) {
        return (student && (student.id || student.studentId || student.student_id)) || '';
    }
    function getStudentFirst(student) {
        return (student && (student.firstName || student.first_name || student.firstname)) || '';
    }
    function getStudentLast(student) {
        return (student && (student.lastName || student.last_name || student.lastname)) || '';
    }

    // Check Auth and Init (Modified)
    function checkAuth() {
        const currentUser = localStorage.getItem('currentUser');
        if (!currentUser) {
            window.location.href = 'index.html';
            return null;
        }
        return JSON.parse(currentUser);
    }

    window.onload = function() {
        const user = checkAuth();
        if (user) {
            showTab('student_management');
            loadInitialData();
        }
    };


    // 1) fetchStudentRecords - improved to use auth and robust id handling
    async function fetchStudentRecords(searchTerm = '') {
        const tableBody = document.getElementById('student-records-body');
        if (tableBody) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-8 text-gray-500">
                        <div class="flex flex-col items-center">
                            <div class="loading-spinner rounded-full h-8 w-8 border-b-2 border-indigo-600 mb-3" style="animation: spin 1s linear infinite;"></div>
                            <p>Fetching records...</p>
                        </div>
                    </td>
                </tr>
            `;
        }

        try {
            const response = await fetchWithAuth(`${API_BASE_URL}/students`, { method: 'GET' }, true);

            if (!response.ok) {
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('currentUser');
                    window.location.href = 'index.html';
                    return [];
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            const filteredData = (data || []).filter(s => {
                const fn = getStudentFirst(s).toLowerCase();
                const ln = getStudentLast(s).toLowerCase();
                const id = getStudentId(s).toLowerCase();
                const term = (searchTerm || '').toLowerCase();
                return (!term) || fn.includes(term) || ln.includes(term) || id.includes(term);
            });

            showMessage("Data Loaded", `Successfully retrieved ${filteredData.length} student records.`, 'success');

            if (tableBody) {
                if (filteredData.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center py-8 text-gray-500">
                                <p class="font-medium">No records found</p>
                            </td>
                        </tr>
                    `;
                } else {
                    tableBody.innerHTML = filteredData.map(student => {
                        const sid = getStudentId(student);
                        const first = getStudentFirst(student);
                        const last = getStudentLast(student);
                        const email = student.email || student.emailAddress || 'N/A';
                        const major = student.major || '';
                        const initials = (first ? first.charAt(0) : '?') + (last ? last.charAt(0) : '?');
                        return `
                            <tr class="table-row">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="text-sm font-semibold text-gray-900">${sid}</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold avatar-circle">
                                            ${initials}
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900">${first} ${last}</div>
                                            <div class="text-sm text-gray-500">${email}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="badge badge-success">${major}</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                    <button onclick="editStudent('${sid}')" class="text-indigo-600 hover:text-indigo-900 font-semibold">
                                        Edit
                                    </button>
                                    <button onclick="deleteStudent('${sid}')" class="text-red-600 hover:text-red-900 font-semibold">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            }
            return filteredData;
        } catch (error) {
            console.error('Fetch Student Records Error:', error);
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-8 text-red-600">
                            <p class="font-medium">Failed to load data. Is the backend server running?</p>
                            <p class="text-sm mt-2">${error.message}</p>
                        </td>
                    </tr>
                `;
            }
            showMessage("API Error", `Failed to load student data: ${error.message}`, 'error');
            return [];
        }
    }

    // New/Updated Edit/Update functions
    async function editStudent(studentId) {
        try {
            // Fetch current student data
            const resp = await fetchWithAuth(`${API_BASE_URL}/students/${encodeURIComponent(studentId)}`, { method: 'GET' }, true);
            if (!resp.ok) {
                throw new Error(`Failed to fetch student ${studentId}: ${resp.status}`);
            }
            const student = await resp.json();

            // Use simple prompt-based editor for quick admin edits
            const newFirst = window.prompt('First Name:', student.firstName || '');
            if (newFirst === null) return; // cancelled
            const newLast = window.prompt('Last Name:', student.lastName || '');
            if (newLast === null) return;
            const newEmail = window.prompt('Email:', student.email || '');
            if (newEmail === null) return;
            const newMajor = window.prompt('Major:', student.major || '');
            if (newMajor === null) return;

            // Build updated object (preserving existing fields like password, grade etc.)
            const updated = Object.assign({}, student, {
                firstName: newFirst.trim(),
                lastName: newLast.trim(),
                email: newEmail.trim(),
                major: newMajor.trim()
            });

            // Call update
            await updateStudent(studentId, updated);

        } catch (err) {
            console.error('editStudent error', err);
            showMessage('Edit Error', `Could not edit student ${studentId}: ${err.message}`, 'error');
        }
    }

    async function updateStudent(studentId, studentObj) {
        try {
            showMessage("Updating Student", `Updating ${studentId}...`, 'info');

            const resp = await fetchWithAuth(`${API_BASE_URL}/students/${encodeURIComponent(studentId)}`, {
                method: 'PUT',
                body: JSON.stringify(studentObj)
            }, true);

            if (!resp.ok) {
                const errBody = await resp.json().catch(() => ({}));
                throw new Error(errBody.message || `Update failed (${resp.status})`);
            }

            const updated = await resp.json();
            showMessage('Update Success', `Student ${getStudentId(updated)} updated successfully.`, 'success');
            // Refresh records
            setTimeout(() => fetchStudentRecords(''), 600);
            return updated;
        } catch (err) {
            console.error('updateStudent error', err);
            showMessage('Update Failed', err.message || 'Unknown error', 'error');
            throw err;
        }
    }


    // 3) createCourse - authenticated
    async function createCourse(code, name) {
        if (!code || !name) {
            showMessage('Input Missing', 'Please enter both Course Code and Name.', 'error');
            return;
        }

        try {
            showMessage('Course Creation', `Creating course ${code}...`, 'info');

            const response = await fetchWithAuth(`${API_BASE_URL}/courses`, {
                method: 'POST',
                body: JSON.stringify({ courseCode: code, courseName: name, credits: 3 })
            }, true);

            if (!response.ok) {
                const errBody = await response.json().catch(() => ({}));
                throw new Error(errBody.message || `Failed to create course (${response.status})`);
            }

            showMessage('Course Added', `Course ${code} - ${name} added successfully.`, 'success');

            document.getElementById('new-course-code').value = '';
            document.getElementById('new-course-name').value = '';

            loadCourses();
        } catch (error) {
            showMessage('API Error', `Failed to create course: ${error.message}`, 'error');
        }
    }

    // 4) deleteCourse - authenticated
    async function deleteCourse(code) {
        if (!confirm(`Are you sure you want to delete course ${code}?`)) return;

        try {
            showMessage('Delete Course', `Deleting course ${code}...`, 'info');

            const response = await fetchWithAuth(`${API_BASE_URL}/courses/${encodeURIComponent(code)}`, {
                method: 'DELETE'
            }, true);

            if (!response.ok) {
                throw new Error(`Failed to delete course (${response.status})`);
            }

            showMessage('Course Deleted', `Course ${code} deleted successfully.`, 'success');
            loadCourses();
        } catch (error) {
            showMessage('API Error', `Failed to delete course: ${error.message}`, 'error');
        }
    }


    // 5) createStudent - authenticated (admin)
    async function createStudent(studentData) {
        try {
            showMessage("Processing Request", `Adding new student ${studentData.firstName}...`, 'info');

            const response = await fetchWithAuth(`${API_BASE_URL}/students`, {
                method: 'POST',
                body: JSON.stringify(studentData)
            }, true);

            if (!response.ok) {
                const errorBody = await response.json().catch(() => ({}));
                throw new Error(errorBody.message || `HTTP error! status: ${response.status}`);
            }

            const newRecord = await response.json();
            showMessage("Success!", `Student ${newRecord.firstName} (ID: ${getStudentId(newRecord)}) added successfully!`, 'success');

            fetchStudentRecords('');
        } catch (error) {
            console.error('Create Student Error:', error);
            showMessage("API Error", `Failed to create student: ${error.message}`, 'error');
        }
    }

    // 6) deleteStudent - authenticated (admin)
    async function deleteStudent(studentId) {
        if (!confirm(`Are you sure you want to delete student ${studentId}?`)) return;

        try {
            showMessage("Processing Deletion", `Deleting student ${studentId}...`, 'info');

            const response = await fetchWithAuth(`${API_BASE_URL}/students/${encodeURIComponent(studentId)}`, {
                method: 'DELETE'
            }, true);

            if (response.status === 204 || response.ok) {
                showMessage("Deletion Success", `Student ${studentId} has been successfully deleted.`, 'success');
                fetchStudentRecords('');
            } else {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
        } catch (error) {
            console.error('Delete Student Error:', error);
            showMessage("API Error", `Failed to delete student: ${error.message}`, 'error');
        }
    }

    // 7) Fees: use auth for fee endpoints (reads and payment)
    async function fetchFeeRecords(studentId) {
        const idDisplay = document.getElementById('current-fee-id');
        const balanceDisplay = document.getElementById('current-fee-balance');
        const statusBadge = document.getElementById('current-fee-status-badge');
        const paymentDateDisplay = document.getElementById('last-payment-date');

        // Rupee formatter - This is the key change requested
        const rupeeFormatter = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 2 });

        if (!studentId || studentId.trim() === '') {
            showMessage('Input Missing', 'Please enter a Student ID to check fees.', 'error');
            return [];
        }

        idDisplay.textContent = studentId;
        balanceDisplay.textContent = 'Loading...';
        statusBadge.textContent = 'Loading...';
        statusBadge.className = 'badge bg-gray-400 text-white'; // Set class to loading state
        paymentDateDisplay.textContent = 'Loading...';

        try {
            showMessage("Fee Check", `Checking fee records for ID ${studentId}...`, 'info');

            const response = await fetchWithAuth(`${API_BASE_URL}/fees/student/${encodeURIComponent(studentId)}`, { method: 'GET' }, true);

            if (!response.ok) {
                if (response.status === 404) {
                    showMessage("Not Found", `No fee records found for student ID ${studentId}.`, 'error');
                    balanceDisplay.textContent = rupeeFormatter.format(0.00); // Show â‚¹0.00 on not found
                    statusBadge.textContent = 'N/A';
                    statusBadge.className = 'badge bg-gray-200 text-gray-700';
                    paymentDateDisplay.textContent = 'N/A';
                    return [];
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const feeRecords = await response.json();

            let totalPending = (feeRecords || [])
                .filter(f => f.status !== 'Paid')
                .reduce((sum, f) => sum + parseFloat(f.amount || 0), 0);

            const paidRecords = (feeRecords || []).filter(f => f.status === 'Paid');
            // Note: Assuming 'dueDate' is a good proxy for payment date if a separate 'paymentDate' field isn't available on the paid fee record
            const lastPayment = paidRecords.length > 0 ? paidRecords.sort((a,b) => new Date(b.dueDate) - new Date(a.dueDate))[0] : null;

            // ðŸ’¡ FIX 1: Apply INR formatting to the display
            balanceDisplay.textContent = rupeeFormatter.format(totalPending);

            const hasOverdue = (feeRecords || []).some(f => f.status === 'Overdue');
            const hasPending = (feeRecords || []).some(f => f.status === 'Pending');

            if (hasOverdue) {
                statusBadge.textContent = 'OVERDUE';
                statusBadge.className = 'badge badge-danger';
            } else if (hasPending || totalPending > 0) {
                statusBadge.textContent = 'PENDING';
                statusBadge.className = 'badge badge-warning';
            } else {
                statusBadge.textContent = 'PAID';
                statusBadge.className = 'badge badge-success';
            }

            paymentDateDisplay.textContent = lastPayment ? new Date(lastPayment.dueDate).toLocaleDateString() : 'No payments yet';

            // ðŸ’¡ FIX 2: Apply INR formatting to the message
            showMessage("Fee Data Loaded", `Total pending: ${rupeeFormatter.format(totalPending)}`, 'success');
            return feeRecords;
        } catch (error) {
            console.error('Fetch Fee Records Error:', error);
            idDisplay.textContent = studentId;
            balanceDisplay.textContent = 'Error';
            statusBadge.textContent = 'ERROR';
            statusBadge.className = 'badge badge-danger';
            paymentDateDisplay.textContent = 'Error';
            showMessage("API Error", `Failed to load fee data: ${error.message}`, 'error');
            return [];
        }
    }

    async function recordPayment(studentId) {
        if (!studentId || studentId.trim() === '') {
            showMessage('Input Missing', 'Please enter a Student ID first.', 'error');
            return;
        }

        // Rupee formatter (Needed for the success message)
        const rupeeFormatter = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 2 });

        try {
            const feeRecords = await fetchFeeRecords(studentId);
            if (!feeRecords || feeRecords.length === 0) {
                showMessage("No Records", `No fee records found for ${studentId}`, 'error');
                return;
            }

            const oldestPendingFee = feeRecords.filter(f => f.status !== 'Paid').sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate))[0];
            if (!oldestPendingFee) {
                showMessage("No Dues", `Student ${studentId} has no pending fees to pay.`, 'info');
                return;
            }

            const feeIdToPay = oldestPendingFee.feeId;
            showMessage("Processing Payment", `Recording payment for fee ID ${feeIdToPay}...`, 'info');

            const response = await fetchWithAuth(`${API_BASE_URL}/fees/${encodeURIComponent(feeIdToPay)}/pay`, { method: 'PUT' }, true);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const paidFee = await response.json();
            // ðŸ’¡ FIX 3: Apply INR formatting to the success message
            showMessage("Payment Success", `Fee ID ${paidFee.feeId} for ${rupeeFormatter.format(parseFloat(paidFee.amount || 0))} marked as PAID.`, 'success');

            setTimeout(() => fetchFeeRecords(studentId), 1000);
        } catch (error) {
            console.error('Record Payment Error:', error);
            showMessage("API Error", `Failed to record payment: ${error.message}`, 'error');
        }
    }

    // 8) updateGrade (FIXED)
    async function updateGrade(studentId, courseCode, newGrade) {
        showMessage("Processing Update", `Updating grade for ${studentId} in ${courseCode}...`, 'info');

        const token = getAuthToken();

        try {
            const updateData = { studentId, courseCode, grade: newGrade };

            const response = await fetch(`${API_BASE_URL}/academics/grade`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token || ''}`
                },
                body: JSON.stringify(updateData)
            });

            if (!response.ok) {
                const errorBody = await response.json().catch(() => ({}));
                const errorMessage = errorBody.message || response.statusText || 'Unknown server error.';
                throw new Error(`HTTP error! Status ${response.status}: ${errorMessage}`);
            }

            const updatedRecord = await response.json();

            showMessage(
                "Update Complete",
                `Grade for ${updatedRecord.studentId} in ${updatedRecord.courseCode} successfully updated to ${updatedRecord.grade}!`,
                'success'
            );

            document.getElementById('grade-student-id').value = '';
            document.getElementById('grade-course-code').value = '';
            document.getElementById('grade-select').value = '';

        } catch (error) {
            console.error('Update Grade Error:', error);
            showMessage("API Error", `Failed to update grade: ${error.message}`, 'error');
        }
    }


    function handleGradeUpdate() {
        const studentId = document.getElementById('grade-student-id').value.trim();
        const courseCode = document.getElementById('grade-course-code').value.trim();
        const newGrade = document.getElementById('grade-select').value;

        if (!studentId || !courseCode || !newGrade) {
            showMessage('Input Missing', 'Please fill in all fields (ID, Course Code, Grade).', 'error');
            return;
        }

        updateGrade(studentId, courseCode, newGrade);
    }


    // 9) handleLogout - clear token and currentUser
    function handleLogout() {
        localStorage.removeItem('currentUser');
        localStorage.removeItem('authToken');
        localStorage.removeItem('token');
        showMessage('Logging Out', 'Redirecting to login page...', 'info');
        setTimeout(() => {
            window.location.href = 'index.html';
        }, 800);
    }

    function loadInitialData() {
        fetchStudentRecords('');
        loadCourses();
    }

    // 10) Missing Functions (Placeholder/Retained)

    async function loadCourses() { /* Implemented from previous step */
        try {
            const response = await fetchWithAuth(`${API_BASE_URL}/courses`, { method: 'GET' }, true);
            if (!response.ok) throw new Error('Failed to load courses');

            const courses = await response.json();
            const courseList = document.getElementById('course-list');

            if (courseList && courses.length > 0) {
                courseList.innerHTML = courses.map(course => `
                    <div class="course-card flex justify-between items-center p-4 bg-white rounded-xl">
                        <div>
                            <p class="font-semibold text-gray-800">${course.courseCode}</p>
                            <p class="text-sm text-gray-600">${course.courseName}</p>
                        </div>
                        <button onclick="deleteCourse('${course.courseCode}')" class="px-4 py-2 bg-red-50 text-red-600 rounded-lg font-semibold hover:bg-red-100 transition" style="box-shadow: 0 2px 6px rgba(239, 68, 68, 0.2);">
                            Delete
                        </button>
                    </div>
                `).join('');
            } else if (courseList) {
                courseList.innerHTML = '<div class="text-center py-8 text-gray-500"><p>No courses found</p></div>';
            }
        } catch (error) {
            const courseList = document.getElementById('course-list');
            if (courseList) {
                courseList.innerHTML = '<div class="text-center py-8 text-red-500"><p>Failed to load courses</p></div>';
            }
        }
    }

    async function createCourse(code, name) { /* Retained */
        if (!code || !name) {
            showMessage('Input Missing', 'Please enter both Course Code and Name.', 'error');
            return;
        }

        try {
            showMessage('Course Creation', `Creating course ${code}...`, 'info');

            const response = await fetchWithAuth(`${API_BASE_URL}/courses`, {
                method: 'POST',
                body: JSON.stringify({ courseCode: code, courseName: name, credits: 3 })
            }, true);

            if (!response.ok) throw new Error('Failed to create course');

            showMessage('Course Added', `Course ${code} - ${name} added successfully.`, 'success');

            document.getElementById('new-course-code').value = '';
            document.getElementById('new-course-name').value = '';

            loadCourses();
        } catch (error) {
            showMessage('API Error', `Failed to create course: ${error.message}`, 'error');
        }
    }

    async function deleteCourse(code) { /* Retained */
        if (!confirm(`Are you sure you want to delete course ${code}?`)) return;

        try {
            showMessage('Delete Course', `Deleting course ${code}...`, 'info');

            const response = await fetchWithAuth(`${API_BASE_URL}/courses/${encodeURIComponent(code)}`, {
                method: 'DELETE'
            }, true);

            if (!response.ok) throw new Error('Failed to delete course');

            showMessage('Course Deleted', `Course ${code} deleted successfully.`, 'success');
            loadCourses();
        } catch (error) {
            showMessage('API Error', `Failed to delete course: ${error.message}`, 'error');
        }
    }

    // --- END: Integrated and Fixed Functions ---
</script>
</body>
</html>